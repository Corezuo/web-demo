<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="#" />
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../assets/bootstrap.css">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <div class="col-lg-12">
            <div class="row">
                <h3 style="text-align:center">JVM内存监控图</h3>
                <p style="text-align: center;" id="initValue"></p>
                <div id="heapLine" style="width: 100%;height: 400px;"></div>
            </div>
            <div class="row">
                <h3 style="text-align:center">JVM线程监控图</h3>
                <div id="threadLine" style="width: 100%;height: 400px;"></div>
            </div>
            <div class="row">
                <h3 style="text-align: center">GC监控图</h3>
                <div id="gcLine" style="width: 100%;height: 400px;"></div>
            </div>
        </div>
    </div>
    <script type="application/javascript" src="../assets/echarts-4.2.0/echarts.min.js"></script>
    <script type="application/javascript" src="../assets/jquery-3.3.1.js"></script>
    <script type="application/javascript" src="main.js"></script>
    <script type="application/javascript">
        var heapChart = echarts.init(document.getElementById("heapLine"));
        var threadChart = echarts.init(document.getElementById("threadLine"));
        var gcChart = echarts.init(document.getElementById("gcLine"));

        var edenData = [],
            surData = [],
            oldData = [],
            metaData = [],
            threads = [],
            httpThreads = [],
            dubboThreads = [],
            edenSpaceCollecteds = [],
            survivorSpaceCollecteds = [],
            oldGenCollecteds = [];
            timeData = [];

        pageCallback(1, 30, function(data, total) {
            // JVM 配置的最大值
            var value = "Eden Space：" + data[0].edenMaxBytes + "MB"
                + " Survivor Space：" + data[0].surMaxBytes + "MB"
                + " Tenured Space：" + data[0].oldMaxBytes + "MB"
                + " Meta Space：" + data[0].permMaxBytes + "MB";
            $("#initValue").text(value);

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                edenData.unshift(parseInt(item.edenUseBytes));
                surData.unshift(parseInt(item.surUsedBytes));
                oldData.unshift(parseInt(item.oldUsedBytes));
                metaData.unshift(parseInt(item.permUsedBytes));
                threads.unshift(parseInt(item.runCount));
                httpThreads.unshift(parseInt(item.httpRunCount));
                dubboThreads.unshift(parseInt(item.dubboRunCount));
                edenSpaceCollecteds.unshift(parseInt(item.edenSpaceCollected));
                survivorSpaceCollecteds.unshift(parseInt(item.survivorSpaceCollected));
                oldGenCollecteds.unshift(parseInt(item.oldGenCollected));
                var date = new Date(Date.parse(item.collect_time));
                timeData.unshift(date.Format("HH:mm:ss"));
            }
            heapChart.setOption(heapOption);
            threadChart.setOption(threadOption);
            gcChart.setOption(gcOption);
        });
        var heapOption = {
            title: {
                text: 'JVM堆内存监控图',
                show: false
            },
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: {
                data: ["Eden Space", "Survivor Space", "Tenured Gen", "Meta Space"]
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis : [
                {
                    type : 'category',
                    name: "时间",
                    boundaryGap : false,
                    data : timeData
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    name: "内存使用（MB）"
                }
            ],
            series : [
                {
                    name:'Eden Space',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: edenData
                },
                {
                    name:'Survivor Space',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: surData
                },
                {
                    name:'Tenured Gen',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: oldData
                },
                {
                    name:'Meta Space',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: metaData
                }
            ]
        };
        var threadOption = {
            title: {
                text: 'JVM线程监控图',
                show: false
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data:['运行总量', 'http运行量', 'dubbo运行量']
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            xAxis: {
                type: 'category',
                name: "时间",
                boundaryGap: false,
                data: timeData
            },
            yAxis: {
                type: 'value',
                name: "线程数"
            },
            series: [
                {
                    name:'运行总量',
                    type:'line',
                    stack: '总量',
                    data: threads
                },
                {
                    name:'http运行量',
                    type:'line',
                    stack: '总量',
                    data: httpThreads
                },
                {
                    name:'dubbo运行量',
                    type:'line',
                    stack: '总量',
                    data: dubboThreads
                }
            ]
        };
        var gcOption = {
            title: {
                text: 'GC监控图',
                show: false
            },
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            legend: {
                data: ["Eden Space", "Survivor Space", "Tenured Gen"]
            },
            toolbox: {
                feature: {
                    saveAsImage: {}
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis : [
                {
                    type : 'category',
                    name: "时间",
                    boundaryGap : false,
                    data : timeData
                }
            ],
            yAxis : [
                {
                    type : 'value',
                    name: "回收内存（MB）"
                }
            ],
            series : [
                {
                    name:'Eden Space',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: edenSpaceCollecteds
                },
                {
                    name:'Survivor Space',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: survivorSpaceCollecteds
                },
                {
                    name:'Tenured Gen',
                    type:'line',
                    stack: '总量',
                    areaStyle: {},
                    data: oldGenCollecteds
                }
            ]
        };
    </script>
</body>
</html>
