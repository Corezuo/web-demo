<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="../assets/bootstrap.css">
    <title>应用开发工具</title>
    <style type="text/css">
        .sandbox-hidden {
            display: none;
        }
        .sandbox {
            width: 50vw;
            height: 50vh;
            border: 1px solid black;
            position: fixed;
            bottom: 0;
            right: 0;
        }
        .sandbox-full-screen {
            width: 100vw;
            height: 100vh;
        }
        .sandbox > .sandbox-btn-group {
            padding: 5px;
            background-color: white;
        }
        .sandbox > .sandbox-info-panel {
            background-color: black;
            color: white;
            height: 100%;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1 class="text-center" style="margin-top: 100px;">应用调试：<small>按组合快捷键 Alt + Z </small></h1>
    <div id="sandbox" class="sandbox sandbox-hidden">
        <div class="sandbox-btn-group">
            <div class="sandbox-btn-group-row">
                <span>日志级别：</span>
                <select id="sandbox-log-level">
                    <option selected="selected">DEBUG</option>
                    <option>INFO</option>
                    <option>WARN</option>
                    <option>ERROR</option>
                </select>
                <button type="button" id="sandbox-refreshBtn">刷新</button>
                <button type="button" id="sandbox-fullScreenBtn">全屏</button>
                <button type="button" id="sandbox-closeBtn">关闭</button>
            </div>
        </div>
        <div class="sandbox-info-panel">
            <table id="sandbox-info-list"></table>
        </div>
    </div>
    <script type="application/javascript" src="../assets/jquery-3.3.1.js"></script>
    <script type="application/javascript" src="../assets/template-web.js"></script>
    <script type="application/javascript">
        $(function () {
            // 监听快捷键 Alt + z
            $(document).keydown(
                function (event) {
                    if (event.keyCode === 90 && event.altKey) {
                        // $("#sandbox").toggleClass("sandbox-hidden");
                        window.open("monitor/logs.html", "_blank", "width=800,height=500,top=200,left=200")
                    }
                }
            );
            // 刷新数据
            $("#sandbox-refreshBtn").on("click", function () {
                pageCallback(1, 30, function (data, total) {
                    console.log("data: ", data);
                    var html = template("sandbox-info-list-temp", {dataList: data});
                    $("#sandbox-info-list").html(html);
                })
            });
            // 全屏
            $("#sandbox-fullScreenBtn").on("click", function () {
                var flag = $("#sandbox").hasClass("sandbox-full-screen");
                if (flag) {
                    $("#sandbox").removeClass("sandbox-full-screen");
                    $("#sandbox-fullScreenBtn").text("全屏");
                } else {
                    $("#sandbox").addClass("sandbox-full-screen");
                    $("#sandbox-fullScreenBtn").text("还原");
                }
            });
            // 关闭
            $("#sandbox-closeBtn").on("click", function () {
                $("#sandbox").toggleClass("sandbox-hidden");
            });
        });

        /**
         * 请求数据
         * @param index    当前页码
         * @param limit    查询数量
         * @param callback 回调函数
         */
        function pageCallback(index, limit, callback) {
            var logLevel = $('#sandbox-log-level').val(),
                finalName = "",
                host = "",
                keyword = "",
                startDate = "",
                endDate = "",
                match = {},
                params = {},
                must = [];
            if (logLevel != null && logLevel.trim() !== "") {
                if (logLevel === "WARN") {
                    logLevel += " ERROR"
                }
                if (logLevel === "INFO") {
                    logLevel += " WARN ERROR";
                }
                if (logLevel === "DEBUG") {
                    logLevel += " INFO WARN ERROR";
                }
                match = {"log_level": logLevel.trim()};
                must.push({match: match});
            } else {
                match = {"log_level": "DEBUG INFO WARN ERROR"};
                must.push({match: match});
            }
            if (finalName != null && finalName.trim() !== "") {
                match = {"finalName": finalName.trim()};
                must.push({match: match});
            }
            if (host != null && host.trim() !== "") {
                match = {"host": host.trim()};
                must.push({match: match});
            }
            if (keyword != null && keyword.trim() !== "") {
                match = {"message": keyword.trim()};
                must.push({match: match});
            }
            if (startDate != null && endDate != null && startDate.trim() !== "" && endDate.trim() !== "") {
                var range = {
                    "log_timestamp": {
                        "from": startDate.trim(),
                        "to": endDate.trim(),
                        "format": "yyyy-MM-dd HH:mm:ss",
                        "time_zone": "+08:00"
                    }
                };
                must.push({range: range});
            }
            params.query = {
                "bool": {
                    "must": must
                }
            };
            params.from = (index - 1) * limit;
            params.size = limit;
            params.sort = [{"log_timestamp": "desc"}];
            console.log("==============请求结果================");
            console.log(params);
            console.log("==============请求结果================");

            $.ajax({
                url: "http://139.129.xxx.xxx:9200/zxcity_elk/file/_search",
                type: "POST",
                dateType: "json",
                data: JSON.stringify(params),
                contentType: "application/json; charset=UTF-8",
                success: function (res) {
                    console.log("==============请求结果================");
                    console.log(res);
                    console.log("==============请求结果================");
                    var dataList = res.hits.hits,
                        total = res.hits.total,
                        data = [];
                    for (var i = 0; i < dataList.length; i++) {
                        data.push(dataList[i]._source);
                    }
                    return callback(data, total);
                },
                error: function (res) {
                    console.log("error: ", res);
                }
            });
        }
    </script>

    <!--templates-->
    <script type="text/html" id="sandbox-info-list-temp">
        {{each dataList}}
        <tr>
            <td>{{$value.message}}</td>
        </tr>
        {{/each}}
    </script>
</body>
</html>
